<!doctype html>
<html lang="ar" dir="rtl" data-theme="cyan">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOMEY — متجر إلكتروني تجريبي</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* =====================
       الثيمات (سماوي، أحمر، أخضر)
       ===================== */
    :root{
      --ink:#0f172a; --ink-2:#334155;
      --glass:255 255 255/.65; --glass-b:255 255 255/.32;
      --radius:16px; --danger:#ff5b5b; --ok:#22c55e;
      --focus: color-mix(in oklab, var(--green), black 20%);
      --panel-grad:linear-gradient(180deg,#e8fff5,#dbfff6);
      --gloss:linear-gradient(180deg,#ffffff66 0%,#ffffff22 40%,#0000 60%);
      --shadow:0 10px 30px rgba(0, 186, 199, .18);
      --grad:linear-gradient(135deg,#cffafe,#a5f3fc 45%,#e0f2fe);
    }
    /* سماوي */
    html[data-theme="cyan"]{
      --green:#06b6d4;
      --shadow:0 10px 30px rgba(6,182,212,.18);
      --grad:linear-gradient(135deg,#cffafe,#a5f3fc 45%,#e0f2fe);
      --panel-grad:linear-gradient(180deg,
        color-mix(in oklab, #06b6d4, white 90%),
        color-mix(in oklab, #06b6d4, white 82%)
      );
    }
    /* أحمر */
    html[data-theme="red"]{
      --green:#ef4444;
      --shadow:0 10px 30px rgba(239,68,68,.18);
      --grad:linear-gradient(135deg,#ffe4e6,#fecaca 45%,#fee2e2);
      --panel-grad:linear-gradient(180deg,
        color-mix(in oklab, #ef4444, white 90%),
        color-mix(in oklab, #ef4444, white 82%)
      );
    }
    /* أخضر */
    html[data-theme="green"]{
      --green:#22c55e;
      --shadow:0 10px 30px rgba(34,197,94,.18);
      --grad:linear-gradient(135deg,#dcfce7,#bbf7d0 45%,#86efac);
      --panel-grad:linear-gradient(180deg,
        color-mix(in oklab, #22c55e, white 90%),
        color-mix(in oklab, #22c55e, white 82%)
      );
    }

    @media (prefers-color-scheme:dark){
      :root{
        --ink:#e6f4ee; --ink-2:#b4c8bf; --glass:10 20 26/.35; --glass-b:255 255 255/.15;
        --grad:radial-gradient(1200px_600px at 80% -10%, #0b2f24, transparent),
               radial-gradient(900px_500px at 10% 110%, #07362a, transparent);
      }
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, "Noto Kufi Arabic", sans-serif; color:var(--ink);
      background:var(--grad); background-attachment: fixed; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    *{box-sizing:border-box}
    a{color:inherit; text-decoration:none}
    img{max-width:100%; display:block}
    button{font:inherit; cursor:pointer}
    :focus-visible{outline:2px solid var(--focus); outline-offset:2px}
    @media (prefers-reduced-motion:reduce){
      *{animation:none!important; transition:none!important}
    }

    /* =====================
       عناصر زجاجية ومساعدة
       ===================== */
    .glass{
      background: color-mix(in oklab, rgb(var(--glass)) 90%, transparent);
      border:1px solid rgb(var(--glass-b)); box-shadow:var(--shadow); border-radius:var(--radius);
      backdrop-filter: blur(12px) saturate(120%); -webkit-backdrop-filter: blur(12px) saturate(120%);
      position:relative;
    }
    .chip{padding:.45rem .7rem; border-radius:999px; border:1px solid rgb(var(--glass-b)); background:color-mix(in oklab,rgb(var(--glass)) 88%, transparent)}
    .btn{display:inline-block; background:var(--green); color:#03230e; border:none; border-radius:12px; padding:.65rem .8rem; font-weight:800; text-align:center; transition:transform .12s ease, box-shadow .12s ease}
    .btn:is(:hover,:focus-visible){transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-ghost{background:color-mix(in oklab, rgb(var(--glass)) 90%, transparent); border:1px solid rgb(var(--glass-b)); border-radius:12px; padding:.6rem .8rem}
    .icon{inline-size:22px; block-size:22px}
    .visually-hidden{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

    /* =====================
       الهيدر + مبدّل ألوان
       ===================== */
    .header{position:sticky; top:0; z-index:60; border-bottom:1px solid rgb(var(--glass-b));
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      background: color-mix(in oklab, rgb(var(--glass)) 92%, transparent);
      transition: box-shadow .25s ease;
    }
    .nav{display:grid; grid-template-columns:auto 1fr auto auto auto auto; gap:.75rem; align-items:center; padding:.6rem .8rem}
    .brand{display:flex; align-items:center; gap:.6rem; font-weight:900; letter-spacing:.2px}
    .dot{inline-size:34px; block-size:34px; border-radius:10px; background:var(--green); display:grid; place-items:center; box-shadow:var(--shadow)}
    .search{display:flex; align-items:center; gap:.5rem; padding:.5rem .7rem; border-radius:999px}
    .search input{all:unset; direction:rtl; inline-size:100%}
    .btn-ico{position:relative; padding:.5rem; border-radius:12px}
    .badge{position:absolute; inset-inline-start:-6px; inset-block-start:-6px; background:var(--green); color:#062014; border-radius:999px; padding:1px 6px; font-size:.72rem; border:1px solid #0001}
    .theme-switch{display:flex; gap:.35rem; align-items:center}
    .swatch{inline-size:18px; block-size:18px; border-radius:6px; border:1px solid rgb(var(--glass-b)); cursor:pointer}
    .swatch[data-t="cyan"]{background:#06b6d4}
    .swatch[data-t="red"]{background:#ef4444}
    .swatch[data-t="green"]{background:#22c55e}

    /* =====================
       تخطيط الصفحة
       ===================== */
    .page{display:grid; gap:.8rem; padding:12px}

    /* شريط “مزاج اليوم” */
    .mood{display:flex; gap:.5rem; overflow:auto; padding:.2rem .1rem}
    .mood .chip{white-space:nowrap; font-weight:800}

    /* قصص/عروض */
    .stories{display:grid; grid-auto-flow:column; grid-auto-columns:minmax(120px,1fr); gap:.6rem; overflow:auto; scroll-snap-type:inline mandatory; padding-block:.2rem}
    .story{scroll-snap-align:start; padding:14px; text-align:center; font-weight:800}

    /* كبسولات Homey (لوحات فئات) */
    .capsules{display:grid; grid-template-columns:1fr; gap:.8rem}
    .capsule{
      position:relative; padding:16px; display:grid; grid-template-columns:64px 1fr auto; gap:.8rem; align-items:center;
      background:var(--panel-grad); border-radius:16px
    }
    .capsule .ico{inline-size:48px; block-size:48px; border-radius:14px; background:var(--green); display:grid; place-items:center; box-shadow:var(--shadow)}
    .capsule h3{margin:0; font-size:1rem}
    .capsule p{margin:0; color:var(--ink-2); font-size:.9rem}
    .capsule a{font-weight:800}

    /* تبويبات محتوى */
    .tabs{display:flex; gap:.5rem; align-items:center; overflow:auto; padding:.2rem; position:relative}
    .tab{border:1px solid rgb(var(--glass-b)); background:color-mix(in oklab,rgb(var(--glass)) 88%, transparent); padding:.45rem .8rem; border-radius:999px; font-weight:700; white-space:nowrap}
    .tab[aria-selected="true"]{background:var(--green); color:#062014}
    .tabs .indicator{position:absolute; inset-block-end:-2px; height:3px; border-radius:999px; background:var(--green); transition:transform .25s ease,width .25s ease}

    /* فلاتر/منتجات */
    .filters{display:grid; gap:.6rem; padding:12px}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:.6rem}
    select, input[type=number]{all:unset; display:block; width:100%; padding:.6rem}

    .products{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.6rem}
    .card{padding:.6rem; display:grid; gap:.5rem; position:relative; min-height:340px; transition:transform .15s ease, box-shadow .15s ease; overflow:hidden; border-radius:16px}
    .card:hover{transform: translateY(-2px)}
    .card::before{content:""; position:absolute; inset:0; background:var(--gloss); opacity:0; transition:opacity .2s ease; pointer-events:none; z-index:0}
    .card:hover::before{opacity:.8}
    .fav{position:absolute; inset-inline-start:8px; inset-block-start:8px; z-index:2}
    .price{display:flex; gap:.4rem; align-items:baseline}
    .price s{color:var(--ink-2); font-size:.85rem}
    .badge-corner{position:absolute; inset-block-start:10px; inset-inline-end:10px; background:color-mix(in oklab, var(--green), white 40%); color:#062014; padding:.25rem .5rem; border-radius:999px; font-size:.78rem; border:1px solid rgb(var(--glass-b)); z-index:2}

    /* Skeleton */
    .skeleton{background:linear-gradient(90deg,#0000 0,#ffffff33 50%,#0000 100%), #0001; background-size:200% 100%; animation:sh 1s linear infinite}
    @keyframes sh{to{background-position:-200% 0}}

    /* مودالات عامة */
    .overlay{position:fixed; inset:0; background:rgba(15,23,42,.35); backdrop-filter:blur(4px); display:none}
    .overlay.show{display:grid; place-items:end}
    .overlay.center.show{place-items:center}
    .dialog{padding:12px; width:100%; max-width:520px; margin:0 12px 12px}
    .dialog .head{display:flex; justify-content:space-between; align-items:center}

    /* مودالات السلة/الدخول/الحساب */
    .cart-dialog,.auth-dialog,.acct-dialog{padding:12px; width:100%; max-width:560px; border-radius:16px; position:relative; overflow:hidden}
    .cart-dialog:before,.auth-dialog:before,.acct-dialog:before{
      content:""; position:absolute; inset:0; border-radius:inherit;
      border:1px solid rgb(var(--glass-b)); pointer-events:none;
      box-shadow: inset 0 1px 0 #fff3, inset 0 0 0 1px #fff2;
    }

    /* Toast */
    #toast{position:fixed; inset-inline:12px; inset-block-end:24px; padding:10px 14px; display:none; font-weight:700}
    #toast.show{display:block}

    /* حالات فارغة */
    .empty{padding:16px; text-align:center; color:var(--ink-2)}

    /* التذييل المصغّر */
    .footer{margin:16px 12px; padding:12px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}

    /* دخول على Scroll (Reveal) */
    .reveal{opacity:0; transform:translateY(10px); transition:opacity .4s ease, transform .4s ease}
    .reveal.in{opacity:1; transform:none}

    /* تابلت/ديسكتوب */
    @media (min-width:768px){
      .page{grid-template-columns:280px 1fr; align-items:start}
      .filters{position:sticky; top:64px}
      .products{grid-template-columns: repeat(3, minmax(0,1fr))}
      .capsules{grid-template-columns:repeat(2,1fr)}
    }
    @media (min-width:1200px){
      .products{grid-template-columns: repeat(4, minmax(0,1fr))}
      .capsules{grid-template-columns:repeat(4,1fr)}
    }

    /* =====================
       جماليات إضافية (ثابتة ومعدّلة)
       ===================== */

    /* خلفية تتحرّك بنعومة */
    @media (prefers-reduced-motion:no-preference){
      body{ background-size:200% 200%; animation:bg-pan 22s ease-in-out infinite; }
      @keyframes bg-pan{
        0%{ background-position:0% 0% } 50%{ background-position:100% 100% } 100%{ background-position:0% 0% }
      }
    }

    /* Noise خفيف — لا يطبق على كروت المنتجات */
    :root{
      --noise: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 60'>\
<filter id='n'><feTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/>\
<feColorMatrix type='saturate' values='0'/>\
<feComponentTransfer><feFuncA type='table' tableValues='0 0 .06 .12'/></feComponentTransfer></filter>\
<rect width='100%' height='100%' filter='url(%23n)'/></svg>");
    }
    /* تم استثناء .card هنا */
    .glass:not(.card)::after{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background-image:var(--noise); mix-blend-mode:soft-light; opacity:.18;
    }

    /* تكبير رقيق لصورة المنتج على الهوفر */
    .card img{ transition:transform .35s ease }
    .card:hover img{ transform:scale(1.04) }
    .card:hover{ box-shadow:0 12px 28px rgba(0,0,0,.10), 0 6px 12px rgba(0,0,0,.06) }

    /* Ripple للأزرار/الشيبس */
    .btn, .btn-ghost, .chip{ position:relative; overflow:hidden }
    .ripple{
      position:absolute; border-radius:50%; transform:scale(0);
      background: color-mix(in oklab, var(--green), white 20%);
      opacity:.35; animation:ripple .6s ease-out; pointer-events:none;
    }
    @keyframes ripple{ to{ transform:scale(3); opacity:0 } }

    /* ظل للهيدر عند السحب */
    .header.scrolled{ box-shadow:0 10px 30px rgba(0,0,0,.10) }

    /* توست انزلاقي ناعم */
    #toast{ display:block; opacity:0; pointer-events:none; transform:translateY(8px);
            transition:opacity .25s ease, transform .25s ease }
    #toast.show{ opacity:1; transform:translateY(0) }

    /* بونص للمفضلة */
    .fav svg{ transition:transform .18s ease, fill .18s ease }
    .fav.bounce svg, .fav:active svg{ transform:scale(1.25) }
  </style>
</head>
<body>
  <!-- =====================
       الهيدر
       ===================== -->
  <header class="header">
    <nav class="nav">
      <div class="brand" aria-label="HOMEY">
        <div class="dot" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0b0b0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10l9-7 9 7"/><path d="M9 22V12h6v10"/></svg>
        </div>
        <strong>HOMEY</strong>
      </div>

      <div class="glass search" role="search">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="search" aria-label="بحث" placeholder="ابحث عن منتج…" />
      </div>

      <div class="theme-switch glass" style="padding:.35rem .6rem; border-radius:999px">
        <span style="font-size:.82rem">اللون</span>
        <div class="swatch" data-t="cyan" title="سماوي"></div>
        <div class="swatch" data-t="red" title="أحمر"></div>
        <div class="swatch" data-t="green" title="أخضر"></div>
      </div>

      <button id="btn-fav" class="glass btn-ico" aria-label="المفضلة">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 1 0-7.8 7.8l1 1L12 22l7.8-8.6 1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
      </button>

      <button id="btn-auth" class="glass btn-ico" aria-label="تسجيل الدخول">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </button>

      <button id="btn-cart" class="glass btn-ico" aria-label="السلة">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        <span id="cart-count" class="badge">0</span>
      </button>
    </nav>
  </header>

  <!-- =====================
       المحتوى
       ===================== -->
  <main class="page">
    <!-- فلاتر -->
    <aside class="glass filters reveal" aria-label="فلاتر">
      <div class="grid-2">
        <label>
          <div class="chip" style="margin-bottom:.4rem">الفئة</div>
          <div class="glass"><select id="filter-cat"></select></div>
        </label>
        <label>
          <div class="chip" style="margin-bottom:.4rem">الترتيب</div>
          <div class="glass"><select id="sort">
            <option value="popular">الأكثر شيوعًا</option>
            <option value="price-asc">السعر تصاعدي</option>
            <option value="price-desc">السعر تنازلي</option>
            <option value="alpha">الاسم أبجدي</option>
          </select></div>
        </label>
      </div>
      <div class="grid-2">
        <label>
          <div class="chip" style="margin-bottom:.4rem">حد أدنى</div>
          <div class="glass"><input id="min" type="number" placeholder="0" inputmode="numeric"></div>
        </label>
        <label>
          <div class="chip" style="margin-bottom:.4rem">حد أقصى</div>
          <div class="glass"><input id="max" type="number" placeholder="99999" inputmode="numeric"></div>
        </label>
      </div>
      <button id="reset" class="btn-ghost">إعادة الضبط</button>
      <div class="chip" id="fav-pill" style="display:none">عرض المفضلة فقط مفعّل</div>
    </aside>

    <section style="display:grid; gap:.8rem">
      <!-- شريط “مزاج اليوم” -->
      <div class="mood reveal" id="mood"></div>

      <!-- قصص/عروض -->
      <div class="stories reveal" id="stories"></div>

      <!-- كبسولات Homey (لوحات فئات) -->
      <div class="capsules" id="capsules"></div>

      <!-- تبويبات محتوى -->
      <div class="tabs reveal" role="tablist" aria-label="أقسام">
        <button class="tab" role="tab" aria-selected="true" data-tab="all">الكل</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="bests">الأكثر مبيعًا</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="new">جديد</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="rec">موصى به</button>
      </div>

      <!-- شبكة منتجات -->
      <div class="products reveal" id="grid" aria-live="polite"></div>
      <!-- حالة فارغة -->
      <div id="empty" class="empty" hidden>لا توجد نتائج مطابقة للبحث/الفلاتر.</div>
    </section>
  </main>

  <!-- مودال تفاصيل المنتج -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="glass dialog" role="document">
      <div class="head">
        <strong id="dlg-title">—</strong>
        <button id="dlg-close" class="btn-ghost" aria-label="إغلاق">إغلاق</button>
      </div>
      <img id="dlg-img" alt="" style="border-radius:14px; margin-top:.5rem" decoding="async">
      <div class="price" style="margin-block:.4rem">
        <strong id="dlg-price"></strong>
        <s id="dlg-was"></s>
      </div>
      <p id="dlg-desc" style="color:var(--ink-2)"></p>
      <div id="dlg-specs" style="display:flex; gap:.4rem; flex-wrap:wrap"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:.6rem; margin-top:.6rem">
        <button id="dlg-add" class="btn">إضافة للسلة</button>
        <button id="dlg-fav" class="btn-ghost">أضف للمفضلة</button>
      </div>
    </div>
  </div>

  <!-- مودال السلة — وسط الشاشة -->
  <div id="cart-backdrop" class="overlay center" aria-hidden="true">
    <div class="glass cart-dialog" role="document">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <strong>السلة</strong>
        <button id="cart-close" class="btn-ghost">إغلاق</button>
      </div>
      <div class="glass" style="padding:.6rem; display:flex; gap:.5rem; align-items:center; margin-top:.6rem">
        <input id="coupon" placeholder="كوبون خصم (HOMEY10)" style="all:unset; flex:1; direction:rtl">
        <button id="apply-coupon" class="chip">تطبيق</button>
      </div>
      <div id="cart-items" style="display:grid; gap:.6rem; margin-top:.6rem"></div>
      <div style="display:flex; justify-content:space-between; margin-top:.4rem">
        <span>الخصم</span><strong id="cart-discount">0 ر.س</strong>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:.2rem">
        <strong>الإجمالي</strong>
        <strong id="cart-total">0 ر.س</strong>
      </div>
      <button id="checkout" class="btn" style="display:block; margin-top:.6rem">تأكيد الطلب</button>
    </div>
  </div>

  <!-- مودال تسجيل الدخول — وسط الشاشة -->
  <div id="auth-backdrop" class="overlay center" aria-hidden="true">
    <form id="auth-form" class="glass auth-dialog" role="dialog" aria-modal="true" style="display:grid; gap:.8rem">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <strong>تسجيل الدخول</strong>
        <button id="auth-close" type="button" class="btn-ghost">إغلاق</button>
      </div>
      <label class="glass" style="padding:.6rem; display:grid; gap:.3rem">
        <span class="visually-hidden">البريد الإلكتروني</span>
        <input id="auth-email" type="email" placeholder="البريد الإلكتروني" style="all:unset; direction:rtl">
      </label>
      <label class="glass" style="padding:.6rem; display:grid; gap:.3rem">
        <span class="visually-hidden">كلمة المرور</span>
        <input id="auth-pass" type="password" placeholder="كلمة المرور" style="all:unset; direction:rtl">
      </label>
      <button id="auth-submit" class="btn" type="submit">تسجيل الدخول</button>
      <div style="color:var(--ink-2); font-size:.9rem">قبول وهمي: أي بريد وكلمة مرور غير فاضية.</div>
    </form>
  </div>

  <!-- مودال حسابي (وهمي) -->
  <div id="acct-backdrop" class="overlay center" aria-hidden="true">
    <div class="glass acct-dialog" role="document" aria-label="حسابي">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <strong>حسابي</strong>
        <button id="acct-close" class="btn-ghost">إغلاق</button>
      </div>
      <div id="acct-body" style="margin-top:.6rem; display:grid; gap:.6rem">
        <div class="glass" style="padding:.6rem">
          <strong>الطلبات</strong>
          <div style="color:var(--ink-2); margin-top:.3rem">لا توجد طلبات بعد (وهمية).</div>
        </div>
        <button id="logout" class="btn-ghost">تسجيل الخروج</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="glass" role="status" aria-live="polite">—</div>

  <!-- تذييل مصغّر -->
  <footer class="glass footer reveal">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <strong>HOMEY</strong>
      <span style="color:var(--ink-2)">تجربة تسوّق زجاجية بسيطة وأنيقة.</span>
    </div>
    <nav style="display:flex; gap:10px; flex-wrap:wrap">
      <a class="chip" href="#">عنّا</a>
      <a class="chip" href="#">سياسة وهمية</a>
      <a class="chip" href="#">تواصل</a>
    </nav>
  </footer>

  <script>
    'use strict';

    const $ = sel => document.querySelector(sel);
    const $$ = (sel,root=document) => Array.from(root.querySelectorAll(sel));
    const safeParse = (raw, fallback) => { try { const v = JSON.parse(raw); return v ?? fallback; } catch { return fallback; } };
    const asArray = (v) => Array.isArray(v) ? v : [];
    const SAR = new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR'});

    /* ===== Placeholder SVG ===== */
    const placeholder = (cat='منتج')=>{
      const label = String(cat||'منتج').slice(0,12);
      const svg =
`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='600'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#d1fae5'/><stop offset='100%' stop-color='#a7f3d0'/></linearGradient></defs>
  <rect width='100%' height='100%' fill='url(#g)'/>
  <g fill='none' stroke='#065f46' stroke-width='12' stroke-linecap='round' stroke-linejoin='round' transform='translate(150,180) scale(1.2)'><path d='M3 120l147-110 147 110'/><path d='M120 300V170h60v130'/></g>
  <text x='50%' y='88%' text-anchor='middle' font-size='42' font-family='system-ui' fill='#065f46'>${label}</text>
</svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    };

    /* ===== بيانات (صور حقيقية في نفس المجلد) ===== */
    const PRODUCTS = asArray([
      {id:'p1', name:'سامسونج S25 ألترا', price:4699, was:5299, cat:'جوالات', best:true, rec:true, img:'./S25ULTRA.webp', desc:'هاتف رائد بأداء قوي وبطارية تدوم طويلًا.', specs:['شاشة 6.8"','256GB','كاميرا 200MP']},
      {id:'p2', name:'آيفون 16 برو ماكس', price:5499, was:5999, cat:'جوالات', new:true, rec:true, img:'./IP 16 PRO MAX.png', forcePh:false, desc:'تجربة iOS مع تصميم فخم وأداء سلس.', specs:['شاشة 6.7"','A18','ProMotion']},
      {id:'p3', name:'سماعات Apple Buds', price:899, was:1099, cat:'اكسسوارات', img:'./APPLE BUDS.jpg', desc:'سماعات أبل عالية الجودة.', specs:['عزل ضوضاء','شحن لاسلكي','بطارية طويلة']},
      {id:'p4', name:'Buds 3 Pro', price:799, was:999, cat:'اكسسوارات', img:'./BUDS 3 BRO.webp', desc:'سماعات Buds 3 Pro اللاسلكية.', specs:['صوت نقي','مقاومة ماء','Bluetooth 5.3']},
      {id:'p5', name:'ساعة ذكية سامسونج', price:1299, was:1599, cat:'ساعات', img:'./SAMSUNG.png', desc:'ساعة سامسونج الذكية متعددة المزايا.', specs:['مراقبة نبض','GPS','مقاومة للماء']},
      {id:'p6', name:'آيفون (كلاسيك)', price:3199, was:3699, cat:'جوالات', img:'./IPHONE.png', desc:'نسخة كلاسيك من آيفون مع تحسينات الأداء.', specs:['شاشة 6.1"','128GB','iOS 18']}
    ]);
    const PROMOS = ['خصم %35','شحن مجاني','كوبونات','عروض اليوم'];
    const MOOD = ['مزاج اليوم: هادي 😌','كود HOMEY10 فعّال','توصيل سريع','منتج موصى به','أسعار مخفّضة','زجاج & لمعة ✨'];

    /* ===== الحالة ===== */
    const state = {
      q:'', cat:'الكل', min:0, max:99999, sort:'popular',
      fav:new Set(asArray(safeParse(localStorage.getItem('homey:fav')||'[]', []))),
      cart:safeParse(localStorage.getItem('homey:cart')||'{}', {}),
      user:safeParse(localStorage.getItem('homey:user')||'null', null),
      tab:'all',
      discount:0,
      open:null
    };

    /* ===== عناصر ===== */
    const $grid = $('#grid');
    const $empty = $('#empty');
    const $stories = $('#stories');
    const $mood = $('#mood');
    const $capsules = $('#capsules');
    const $search = $('#search');
    const $cat = $('#filter-cat');
    const $min = $('#min');
    const $max = $('#max');
    const $sort = $('#sort');
    const $reset = $('#reset');
    const $favPill = $('#fav-pill');

    const $overlay = $('#overlay');
    const $dlgTitle = $('#dlg-title');
    const $dlgImg = $('#dlg-img');
    const $dlgPrice = $('#dlg-price');
    const $dlgWas = $('#dlg-was');
    const $dlgDesc = $('#dlg-desc');
    const $dlgSpecs = $('#dlg-specs');
    const $dlgAdd = $('#dlg-add');
    const $dlgFav = $('#dlg-fav');

    const $cartBackdrop = $('#cart-backdrop');
    const $cartItems = $('#cart-items');
    const $cartTotal = $('#cart-total');
    const $cartDiscount = $('#cart-discount');
    const $cartCount = $('#cart-count');
    const $coupon = $('#coupon');
    const $applyCoupon = $('#apply-coupon');

    const $btnCart = $('#btn-cart');
    const $btnFav = $('#btn-fav');
    const $btnAuth = $('#btn-auth');

    const $authBackdrop = $('#auth-backdrop');
    const $authForm = $('#auth-form');
    const $authEmail = $('#auth-email');
    const $authPass = $('#auth-pass');

    const $acctBackdrop = $('#acct-backdrop');
    const $toast = $('#toast');

    /* ===== ثيم محفوظ ===== */
    (function initTheme(){
      const saved = localStorage.getItem('homey:theme');
      if(saved) document.documentElement.setAttribute('data-theme', saved);
      $$('.swatch').forEach(s=>s.addEventListener('click', ()=>{
        const t=s.dataset.t; document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('homey:theme', t);
      }));
    })();

    /* ===== فئات ===== */
    const computeCats = () => {
      try{
        const catList = asArray(PRODUCTS).map(p=>p && p.cat).filter(Boolean);
        return ['الكل', ...Array.from(new Set(catList))];
      }catch(e){ console.error(e); return ['الكل'];}
    };
    let CATS = computeCats();
    const renderCatOptions = (list) => { $cat.innerHTML = asArray(list).map(c=>`<option>${c}</option>`).join(''); };
    renderCatOptions(CATS);

    /* ===== قصص ومزاج اليوم ===== */
    $stories.innerHTML = PROMOS.map(p=>`<div class="glass story">${p}</div>`).join('');
    $mood.innerHTML = MOOD.map(m=>`<span class="chip">${m}</span>`).join('');

    /* ===== كبسولات Homey (فئات) ===== */
    const CAPS = [
      {cat:'جوالات', text:'أحدث الهواتف', sub:'اختيارات أنيقة وسريعة', icon:`<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#0b0b0b" stroke-width="2"><rect x="7" y="2" width="10" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>`},
      {cat:'ساعات', text:'ساعات ذكية', sub:'للياقة والأسلوب', icon:`<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#0b0b0b" stroke-width="2"><circle cx="12" cy="12" r="7"/><path d="M12 9v4l2 2"/><rect x="9" y="1" width="6" height="4" rx="1"/><rect x="9" y="19" width="6" height="4" rx="1"/></svg>`},
      {cat:'سماعات', text:'صوت نقي', sub:'لاسلكي ومريح', icon:`<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#0b0b0b" stroke-width="2"><path d="M3 10a9 9 0 0 1 18 0"/><rect x="3" y="10" width="4" height="10" rx="2"/><rect x="17" y="10" width="4" height="10" rx="2"/></svg>`},
      {cat:'اكسسوارات', text:'إكسسوارات', sub:'شواحن وكوابل', icon:`<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#0b0b0b" stroke-width="2"><path d="M7 7h10v10H7z"/><path d="M3 10h4M17 10h4M10 3v4M14 3v4M10 17v4M14 17v4"/></svg>`},
    ];
    function renderCapsules(){
      const html = CAPS.map(c=>`
        <div class="capsule reveal">
          <div class="ico" aria-hidden="true">${c.icon}</div>
          <div>
            <h3>${c.text}</h3>
            <p>${c.sub}</p>
          </div>
          <a href="#" data-cap="${c.cat}" class="chip">تسوّق الآن</a>
        </div>
      `).join('');
      $capsules.innerHTML = html;
      $$('[data-cap]').forEach(a=>a.addEventListener('click', e=>{
        e.preventDefault();
        state.cat = a.dataset.cap; $cat.value = state.cat; render();
        window.scrollTo({top: 0, behavior:'smooth'});
      }));
    }
    renderCapsules();

    /* ===== صور المنتجات ===== */
    const productImgSrc = p => (p.forcePh || !p.img || !p.img.trim()) ? placeholder(p.cat) : p.img;

    /* ===== Skeleton + Lazy render ===== */
    const makeSkeleton = () => `
      <article class="glass card" aria-hidden="true">
        <div class="skeleton" style="aspect-ratio:1/1; border-radius:12px"></div>
        <div class="skeleton" style="height:16px; border-radius:8px; margin-top:.5rem"></div>
        <div class="skeleton" style="height:12px; width:60%; border-radius:8px"></div>
        <div class="skeleton" style="height:36px; border-radius:10px; margin-top:.4rem"></div>
      </article>`;
    function renderSkeletons(n=8){
      $grid.innerHTML = new Array(n).fill(0).map(makeSkeleton).join('');
      $empty.hidden = true;
    }

    /* ===== بناء الكروت ===== */
    function buildCard(p){
      const badge = p.was ? `<span class="badge-corner">خصم</span>` :
                    p.new ? `<span class="badge-corner">جديد</span>` :
                    p.best ? `<span class="badge-corner">الأكثر مبيعًا</span>` :
                    p.rec ? `<span class="badge-corner">موصى به</span>` : '';
      return `
      <article class="glass card reveal">
        ${badge}
        <button class="btn-ghost fav" aria-label="المفضلة" data-fav="${p.id}">
          <svg class="icon" viewBox="0 0 24 24" fill="${state.fav.has(p.id)?'currentColor':'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 1 0-7.8 7.8l1 1L12 22l7.8-8.6 1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
        </button>
        <a href="#" data-open="${p.id}">
          <img loading="lazy" decoding="async" src="${productImgSrc(p)}"
               data-fallback="${placeholder(p.cat)}"
               onerror="this.onerror=null; this.src=this.dataset.fallback"
               alt="${p.name}"
               style="aspect-ratio:1/1; object-fit:cover; border-radius:12px; background:#e6f7ef">
        </a>
        <div style="display:grid; gap:.3rem">
          <strong style="font-size:.95rem">${p.name}</strong>
          <div class="price"><span style="font-weight:800">${SAR.format(p.price)}</span> ${p.was?`<s>${SAR.format(p.was)}</s>`:''}</div>
        </div>
        <button class="btn" data-add="${p.id}">أضِف للسلة</button>
      </article>`;
    }

    function filterByTab(xs){
      if(state.tab==='bests') return xs.filter(p=>p.best);
      if(state.tab==='new') return xs.filter(p=>p.new);
      if(state.tab==='rec') return xs.filter(p=>p.rec);
      return xs;
    }

    /* ==== جماليات إضافية (JS) ==== */
    function enableRipples(){
      $$('.btn, .btn-ghost, .chip').forEach(el=>{
        if(el.dataset.ripple==='1') return;
        el.dataset.ripple='1';
        el.addEventListener('click', function(e){
          const r=document.createElement('span');
          r.className='ripple';
          const rect=this.getBoundingClientRect();
          const d=Math.max(rect.width, rect.height);
          r.style.width=r.style.height=d+'px';
          r.style.left=(e.clientX-rect.left-d/2)+'px';
          r.style.top=(e.clientY-rect.top-d/2)+'px';
          this.appendChild(r);
          r.addEventListener('animationend', ()=> r.remove());
        }, {passive:true});
      });
    }
    function mountTabIndicator(){
      const tabsEl = document.querySelector('.tabs');
      if(!tabsEl) return;
      let bar = tabsEl.querySelector('.indicator');
      if(!bar){ bar = document.createElement('span'); bar.className='indicator'; tabsEl.appendChild(bar); }
      function move(){
        const active = document.querySelector('.tab[aria-selected="true"]');
        if(!active) return;
        const r = active.getBoundingClientRect();
        const pr = tabsEl.getBoundingClientRect();
        bar.style.width = r.width + 'px';
        bar.style.transform = `translateX(${r.left - pr.left}px)`;
      }
      move();
      window.addEventListener('resize', move);
      $$('.tab').forEach(t=> t.addEventListener('click', ()=> setTimeout(move, 0)));
    }
    function headerShadowOnScroll(){
      const h = document.querySelector('.header');
      if(!h) return;
      const on = ()=> h.classList.toggle('scrolled', window.scrollY > 6);
      on(); window.addEventListener('scroll', on, {passive:true});
    }

    /* ===== رندر الشبكة ===== */
    function render(){
      renderSkeletons(6);
      requestAnimationFrame(()=>{
        let xs = asArray(PRODUCTS).filter(p => (
          (!state.q || (p.name + (p.desc||'') + ((p.tags||[]).join(' '))).includes(state.q)) &&
          (state.cat==='الكل' || state.cat==='❤ المفضلة' || p.cat===state.cat) &&
          p.price>=state.min && p.price<=state.max
        ));
        if(state.cat==='❤ المفضلة') xs = xs.filter(p => state.fav.has(p.id));
        xs = filterByTab(xs);
        if(state.sort==='price-asc') xs.sort((a,b)=>a.price-b.price);
        if(state.sort==='price-desc') xs.sort((a,b)=>b.price-a.price);
        if(state.sort==='alpha') xs.sort((a,b)=>a.name.localeCompare(b.name,'ar'));

        if(!xs.length){ $grid.innerHTML=''; $empty.hidden=false; return; }
        $empty.hidden = true;
        $grid.innerHTML = xs.map(buildCard).join('');
        bindGrid();
        updateCartBadge();
        revealWatch();
        enableRipples();        /* ← جماليات */
      });
    }

    function bindGrid(){
      $$('#grid [data-open]').forEach(el=>el.addEventListener('click', e=>{ e.preventDefault(); openDialog(el.dataset.open); }));
      $$('#grid [data-add]').forEach(el=>el.addEventListener('click', ()=>{ addToCart(el.dataset.add); toast('تمت الإضافة للسلة'); }));
      $$('#grid [data-fav]').forEach(el=>el.addEventListener('click', (ev)=>{
        toggleFav(el.dataset.fav);
        el.classList.add('bounce'); setTimeout(()=>el.classList.remove('bounce'), 180);
      }));
    }

    /* ===== البحث والفلاتر ===== */
    let timer; $search.addEventListener('input', e=>{ clearTimeout(timer); timer=setTimeout(()=>{ state.q=e.target.value.trim(); render(); }, 250); });
    $cat.addEventListener('change', e=>{ state.cat=e.target.value; render(); });
    $min.addEventListener('change', e=>{ state.min=Number(e.target.value||0); render(); });
    $max.addEventListener('change', e=>{ state.max=Number(e.target.value||99999); render(); });
    $sort.addEventListener('change', e=>{ state.sort=e.target.value; render(); });
    $reset.addEventListener('click', ()=>{ state.q=''; $search.value=''; state.cat='الكل'; renderCatOptions(CATS = computeCats()); $cat.value='الكل'; state.min=0; $min.value=''; state.max=99999; $max.value=''; state.sort='popular'; $sort.value='popular'; render(); });

    /* تبويبات */
    $$('.tab').forEach(t=>t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      state.tab = t.dataset.tab;
      render();
    }));
    /* مؤشر التبويبات */
    mountTabIndicator();

    /* ===== المفضلة ===== */
    function toggleFav(id){ state.fav.has(id)? state.fav.delete(id): state.fav.add(id); persist(); $favPill.style.display = (state.cat==='❤ المفضلة')?'inline-block':'none'; render(); }
    $btnFav.addEventListener('click', ()=>{
      if(state.cat!=="❤ المفضلة"){
        state.cat = "❤ المفضلة"; renderCatOptions(["❤ المفضلة", ...CATS]); $cat.value = '❤ المفضلة'; $favPill.style.display='inline-block';
      } else {
        renderCatOptions(CATS); $cat.value='الكل'; state.cat='الكل'; $favPill.style.display='none';
      }
      render();
    });

    /* ===== السلة ===== */
    function addToCart(id){ state.cart[id] = (state.cart[id]||0)+1; persist(); updateCartBadge(); }
    function decFromCart(id){ if(!state.cart[id]) return; state.cart[id]--; if(state.cart[id]<=0) delete state.cart[id]; persist(); renderCart(); updateCartBadge(); }
    function removeFromCart(id){ delete state.cart[id]; persist(); renderCart(); updateCartBadge(); }
    const cartSubtotal = ()=> Object.entries(state.cart).reduce((sum,[id,qty])=>{ const p = PRODUCTS.find(x=>x.id===id); return sum + (p?p.price*qty:0) },0);
    function updateCartBadge(){ const count = Object.values(state.cart).reduce((a,b)=>a+b,0); $cartCount.textContent = count; }

    function renderCart(){
      const entries = Object.entries(state.cart || {});
      if(!entries.length){
        $cartItems.innerHTML = `<div class="empty glass">السلة فارغة.</div>`;
        $cartDiscount.textContent = SAR.format(0);
        $cartTotal.textContent = SAR.format(0);
        return;
      }
      $cartItems.innerHTML = entries.map(([id,qty])=>{
        const p = PRODUCTS.find(x=>x.id===id); if(!p) return '';
        return `
          <div class="glass" style="padding:10px; display:grid; grid-template-columns:64px 1fr auto; gap:.6rem; align-items:center">
            <img loading="lazy" decoding="async" src="${productImgSrc(p)}" data-fallback="${placeholder(p.cat)}"
                 onerror="this.onerror=null; this.src=this.dataset.fallback"
                 alt="" style="width:64px; height:64px; object-fit:cover; border-radius:12px">
            <div>
              <div style="font-weight:700">${p.name}</div>
              <div>${SAR.format(p.price)} × ${qty}</div>
            </div>
            <div style="display:grid; gap:6px">
              <div style="display:flex; gap:6px">
                <button class="chip" data-dec="${id}">−</button>
                <button class="chip" data-inc="${id}">+</button>
              </div>
              <button class="chip" data-del="${id}" style="background:#ffe8e8">حذف</button>
            </div>
          </div>`;
      }).join('');
      const sub = cartSubtotal();
      const disc = state.discount ? Math.min(state.discount, sub) : 0;
      $cartDiscount.textContent = SAR.format(disc);
      $cartTotal.textContent = SAR.format(Math.max(0, sub - disc));
      $$('#cart-items [data-inc]').forEach(b=>b.addEventListener('click',()=>{ addToCart(b.dataset.inc); renderCart(); }));
      $$('#cart-items [data-dec]').forEach(b=>b.addEventListener('click',()=>{ decFromCart(b.dataset.dec); }));
      $$('#cart-items [data-del]').forEach(b=>b.addEventListener('click',()=>{ removeFromCart(b.dataset.del); }));
    }

    $applyCoupon.addEventListener('click', ()=>{
      const code = ($coupon.value||'').trim().toUpperCase();
      if(!code) return toast('أدخل كود خصم');
      if(code==='HOMEY10'){ state.discount = 10; toast('تم تطبيق خصم 10 ر.س'); }
      else { state.discount = 0; toast('الكود غير صالح'); }
      renderCart();
    });

    $('#cart-close').addEventListener('click', ()=> hideModal($cartBackdrop));
    $btnCart.addEventListener('click', ()=>{ showModal($cartBackdrop, $('#cart-close')); renderCart(); });
    $cartBackdrop.addEventListener('click', e=>{ if(e.target===$cartBackdrop) hideModal($cartBackdrop); });
    enableSwipeToClose($cartBackdrop);

    /* ===== تسجيل الدخول / الحساب ===== */
    function openAuth(){ showModal($authBackdrop, $('#auth-close')); }
    function closeAuth(){ hideModal($authBackdrop); }
    $('#auth-close').addEventListener('click', closeAuth);
    $btnAuth.addEventListener('click', ()=>{
      if(state.user) showModal($acctBackdrop, $('#acct-close'));
      else openAuth();
    });
    $authBackdrop.addEventListener('click', e=>{ if(e.target===$authBackdrop) closeAuth(); });
    enableSwipeToClose($authBackdrop);
    enableSwipeToClose($acctBackdrop);
    $('#acct-close').addEventListener('click', ()=> hideModal($acctBackdrop));
    $('#logout').addEventListener('click', ()=>{
      state.user=null; localStorage.removeItem('homey:user'); hideModal($acctBackdrop); toast('تم تسجيل الخروج');
    });

    $('#auth-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = ($authEmail.value||'').trim();
      const pass = ($authPass.value||'').trim();
      if(!email || !pass){ toast('أدخل بريدًا وكلمة مرور'); return; }
      state.user = {email};
      localStorage.setItem('homey:user', JSON.stringify(state.user));
      toast('تم تسجيل الدخول');
      closeAuth();
    });

    $('#checkout').addEventListener('click', ()=>{
      if(!Object.keys(state.cart||{}).length){ toast('السلة فارغة'); return; }
      if(!state.user){ openAuth(); return; }
      toast('تم تأكيد الطلب — (دفع وهمي)');
      state.cart = {}; state.discount=0; persist(); renderCart(); updateCartBadge(); hideModal($cartBackdrop);
    });

    /* ===== مودال التفاصيل ===== */
    function openDialog(id){
      const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
      state.open = id;
      $dlgTitle.textContent = p.name;
      const img = $dlgImg;
      img.loading='lazy'; img.decoding='async';
      img.src = productImgSrc(p);
      img.dataset.fallback = placeholder(p.cat);
      img.onerror = function(){ this.onerror=null; this.src=this.dataset.fallback; };
      img.alt = p.name;
      $dlgPrice.textContent = SAR.format(p.price);
      $dlgWas.textContent = p.was? SAR.format(p.was) : '';
      $dlgDesc.textContent = p.desc || '';
      $dlgSpecs.innerHTML = (p.specs||[]).map(s=>`<span class="chip">${s}</span>`).join('');
      $dlgFav.textContent = state.fav.has(id)? 'مفضلة' : 'أضف للمفضلة';
      showModal($overlay, $('#dlg-close'));
    }
    function closeDialog(){ hideModal($overlay); state.open=null; }
    $('#dlg-close').addEventListener('click', closeDialog);
    $overlay.addEventListener('click', e=>{ if(e.target===$overlay) closeDialog(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ [ $overlay,$cartBackdrop,$authBackdrop,$acctBackdrop ].forEach(hideModal); } });
    $dlgAdd.addEventListener('click', ()=>{ if(!state.open) return; addToCart(state.open); toast('تمت الإضافة للسلة'); });
    $dlgFav.addEventListener('click', ()=>{ if(!state.open) return; toggleFav(state.open); $dlgFav.textContent = state.fav.has(state.open)? 'مفضلة' : 'أضف للمفضلة'; });

    /* ===== Toast ===== */
    function toast(msg){ $toast.textContent = msg; $toast.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>{ $toast.classList.remove('show'); }, 1600); }

    /* ===== تخزين ===== */
    function persist(){
      localStorage.setItem('homey:cart', JSON.stringify(state.cart||{}));
      localStorage.setItem('homey:fav', JSON.stringify([...state.fav]));
      if(state.user) localStorage.setItem('homey:user', JSON.stringify(state.user));
    }

    /* وصولية: trap focus للمودالات */
    let lastFocused=null;
    function focusables(root){ return $$('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])', root).filter(el=>!el.hasAttribute('disabled')); }
    function trapKey(e,root){
      if(e.key!=='Tab') return;
      const f = focusables(root); if(!f.length) return;
      const first=f[0], last=f[f.length-1];
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    }
    function showModal(overlay, firstFocusBtn){
      if(overlay.classList.contains('show')) return;
      lastFocused = document.activeElement;
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      overlay.addEventListener('keydown', modalKeyHandler);
      (firstFocusBtn||focusables(overlay)[0])?.focus();
    }
    function hideModal(overlay){
      if(!overlay.classList.contains('show')) return;
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      overlay.removeEventListener('keydown', modalKeyHandler);
      lastFocused?.focus();
    }
    function modalKeyHandler(e){
      const root = e.currentTarget.querySelector('[role="document"], form') || e.currentTarget;
      trapKey(e, root);
    }

    /* سحب لإغلاق على الجوال */
    function enableSwipeToClose(overlay){
      let startY=null, moved=false;
      overlay.addEventListener('pointerdown', e=>{ if(e.target!==overlay) return; startY=e.clientY; moved=false; });
      overlay.addEventListener('pointermove', e=>{ if(startY===null) return; if(Math.abs(e.clientY-startY)>14) moved=true; });
      overlay.addEventListener('pointerup', e=>{ if(startY===null) return; const dy=e.clientY-startY; if(moved && dy>40) hideModal(overlay); startY=null; moved=false; });
    }

    /* ===== دخول العناصر عند التمرير (Reveal) ===== */
    let io;
    function revealWatch(){
      if(window.matchMedia('(prefers-reduced-motion: reduce)').matches) { $$('.reveal').forEach(el=>el.classList.add('in')); return; }
      if(io){ io.disconnect(); }
      io = new IntersectionObserver((entries)=>{
        entries.forEach(en=>{
          if(en.isIntersecting){ en.target.classList.add('in'); io.unobserve(en.target); }
        });
      },{rootMargin:'-10% 0px -10% 0px'});
      $$('.reveal').forEach(el=>io.observe(el));
    }

    /* ===== اختبارات ===== */
    function assert(name, cond){ if(!cond){ console.error('❌ Test failed:', name); } else { console.log('✅', name); } }
    (function runTests(){
      const CATS = computeCats();
      assert('CATS مصفوفة', Array.isArray(CATS));
      assert('CATS تحتوي "الكل"', CATS.includes('الكل'));
      assert('cartSubtotal على سلة فارغة = 0', (function(){ const old=state.cart; state.cart={}; const v=cartSubtotal(); state.cart=old; return v===0; })());
    })();

    /* ===== بدء التشغيل ===== */
    render();
    revealWatch();
    enableRipples();
    mountTabIndicator();
    headerShadowOnScroll();
  </script>
</body>
</html>
